---
name: writing-feature-spec
description: "Generate feature spec (docs/05-features/) comparing design intent against implementation. Use when a feature is complete and needs documentation before review."
---

## Overview

Produces a feature spec by extracting design intent from planning documents and comparing it against the current implementation. The spec serves as the primary input for `/feature-review`.

Core principle: **design is the source of truth.** User Stories come from design documents, not from reverse-engineering code. Implementation deviations are recorded as facts, not judged.

```
Scope → Collect design sources → Analyze implementation → Extract User Stories → Detect deviations → Write spec
```

## Process

### Step 1: Determine Feature Scope

1. Ask the user which feature to document
2. Use context clues to suggest candidates:
   - Current branch name
   - Recent commits (`git log --oneline -20`)
   - Files changed on this branch vs base
3. Confirm the feature name — this becomes the output filename: `docs/05-features/{feature-name}.md`

### Step 2: Collect Design Sources

Read design documents in priority order:

1. `docs/06-plans/*-design.md` — sections related to this feature
2. `docs/06-plans/*-dev-guide.md` — Phase descriptions covering this feature
3. `docs/06-plans/*.md` — implementation plans with relevant tasks
4. If none of the above contain design intent for this feature → ask the user to describe the expected behavior. Do not reverse-engineer intent from code.

Record which documents and sections were used. These become the "design source" references in the output.

### Step 3: Analyze Implementation

Read the code to understand what was actually built:

1. Identify key files implementing this feature
2. Find user interaction entry points: Button actions, NavigationLink destinations, gesture handlers, menu items, toolbar actions
3. Trace data flow: what models are involved, how state changes propagate
4. Note the file and line number of each entry point

### Step 4: Extract User Stories from Design

From the design documents collected in Step 2 (not from code), extract User Stories in the format:

> 用户可以 {action}

For each User Story, search the codebase for the corresponding implementation entry point:

- **Found, behavior matches design** → ✅ with file:line reference
- **Found, behavior differs from design** → ⚠️ deviation (detail in Step 5)
- **Not found in code** → ❌ not implemented

### Step 5: Detect Deviations

Compare design intent vs actual code for every User Story marked ⚠️ or ❌. Classify each deviation:

| Type | Meaning |
|------|---------|
| `简化` | Feature works but is reduced compared to design |
| `推迟` | Design specifies it but code does not implement it |
| `变更` | Behavior differs from design intent |

Deviations are factual records. Do not judge them as good or bad.

### Step 6: Write Feature Spec

Save to `docs/05-features/{feature-name}.md` using this template:

```markdown
# {Feature Name}

> {One-line description}

**Design sources:**
- `docs/06-plans/YYYY-MM-DD-xxx-design.md` § {section}
- `docs/06-plans/xxx-dev-guide.md` Phase N

---

## User Stories

- 用户可以 {action A} → `{File.swift:line}` ✅
- 用户可以 {action B} → ❌ not implemented
- 用户可以 {action C} → `{File.swift:line}` ⚠️ see deviation record

## Expected Behavior

{Functional behavior extracted from design documents. This describes design intent, not code behavior.}

### Scenario 1: {scenario name}
{Description from the user's perspective}

## Key Files

| File | Responsibility |
|------|----------------|
| `path/File.swift` | description |

## Boundary Conditions / Constraints

- {condition}

## Deviation Record

| # | Type | Design Intent | Current Implementation | Source |
|---|------|---------------|----------------------|--------|
| 1 | 简化 | {what design says} | {what code does} | design.md § X |

No deviations: write "None."

## Change History

| Date | Change |
|------|--------|
| YYYY-MM-DD | Initial spec (generated by /write-feature-spec) |
```

## Rules

- **Design is the source of truth.** User Stories are extracted from design documents, never reverse-engineered from code.
- **No design source → ask the user.** Do not guess intent from code.
- **Deviations are facts, not judgments.** Record what differs; do not label deviations as problems.
- **Output format must be compatible with `/feature-review`.** The "用户可以..." + file:line format is consumed directly by that skill.
